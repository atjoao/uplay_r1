name: Build uplay emulator

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        include:
          - arch: x64
            make_arch: "64"
            suffix: "64"
            asi_loader_arch: "_x64"
          - arch: x86
            make_arch: "32"
            suffix: ""
            asi_loader_arch: ""
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup compiler
      run: |
        sudo apt-get update
        sudo apt-get install -y clang lld mingw-w64
        
    - name: Build with Make
      run: make ARCH=${{ matrix.make_arch }} CROSS=1

    - name: Cache Steamworks SDK
      uses: actions/cache@v4
      id: cache-steamworks
      with:
        path: steam_api${{ matrix.suffix }}.dll
        key: steamworks-sdk-${{ matrix.arch }}-v1

    - name: Download Steamworks SDK
      if: steps.cache-steamworks.outputs.cache-hit != 'true'
      run: |
        if [ "${{ matrix.arch }}" = "x64" ]; then
          curl -L -o "steam_api64.dll" "https://raw.githubusercontent.com/rlabrecque/SteamworksSDK/main/redistributable_bin/win64/steam_api64.dll"
        else
          curl -L -o "steam_api.dll" "https://raw.githubusercontent.com/rlabrecque/SteamworksSDK/main/redistributable_bin/steam_api.dll"
        fi

    - name: Cache Ultimate ASI Loader
      uses: actions/cache@v4
      id: cache-asi-loader
      with:
        path: dinput8.dll
        key: asi-loader-${{ matrix.arch }}-v1

    - name: Download Ultimate ASI Loader
      if: steps.cache-asi-loader.outputs.cache-hit != 'true'
      run: |
        curl -L -o "asi_loader.zip" "https://github.com/ThirteenAG/Ultimate-ASI-Loader/releases/latest/download/Ultimate-ASI-Loader${{ matrix.asi_loader_arch }}.zip"
        unzip asi_loader.zip -d asi_loader_temp
        find asi_loader_temp -name "dinput8.dll" -exec cp {} dinput8.dll \;

    - name: Cache licenses
      uses: actions/cache@v4
      id: cache-licenses
      with:
        path: |
          LICENSE-ASI-Loader.txt
          LICENSE-MinHook.txt
        key: licenses-v1

    - name: Download licenses
      if: steps.cache-licenses.outputs.cache-hit != 'true'
      run: |
        curl -L -o "LICENSE-ASI-Loader.txt" "https://raw.githubusercontent.com/ThirteenAG/Ultimate-ASI-Loader/refs/heads/master/license"
        curl -L -o "LICENSE-MinHook.txt" "https://raw.githubusercontent.com/TsudaKageyu/minhook/master/LICENSE.txt"
      
    - name: Create ASI zip
      run: |
        zip "uplay_emu_asi_${{ matrix.arch }}.zip" \
          "emu.upc_r1_loader${{ matrix.suffix }}.dll" \
          "uplay_asi${{ matrix.suffix }}.asi" \
          "dinput8.dll" \
          "steam_api${{ matrix.suffix }}.dll" \
          "LICENSE-ASI-Loader.txt" \
          "LICENSE-MinHook.txt"
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-${{ matrix.arch }}
        path: |
          uplay_emu_asi_${{ matrix.arch }}.zip
          uplay_r1_loader${{ matrix.suffix }}.dll
        retention-days: 30

  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')
    
    steps:
    - name: Download x64 artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-x64
        path: ./release
        
    - name: Download x86 artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-x86
        path: ./release
        
    - name: Generate release info
      id: release_info
      run: |
        echo "tag=v$(date +'%Y.%m.%d')-$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT
        echo "date=$(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.release_info.outputs.tag }}
        name: Uplay R1 ${{ steps.release_info.outputs.tag }}
        body: |          
          **Build Date:** ${{ steps.release_info.outputs.date }}
          
          > Note that steam_api.dll and steam_api64.dll are not required for the emu to work.
          > Its just for steam hooking with the game, to get stuff like the overlay working.

          ### Downloads
          
          **ASI Version (for games with DLL checks):**
          | File | Description |
          |------|-------------|
          | `uplay_emu_asi_x64.zip` | 64-bit (emu.upc_r1_loader64.dll + uplay_asi64.asi + dinput8.dll + steam_api64.dll ) |
          | `uplay_emu_asi_x86.zip` | 32-bit (emu.upc_r1_loader.dll + uplay_asi.asi + dinput8.dll + steam_api.dll) |
          
          **Standalone (for games without DLL checks):**
          | File | Description |
          |------|-------------|
          | `uplay_r1_loader64.dll` | 64-bit - rename to match your game's Uplay DLL |
          | `uplay_r1_loader.dll` | 32-bit - rename to match your game's Uplay DLL |
          
          ### Usage
          
          **ASI:** Extract zip to game folder  
          **Standalone:** Rename DLL to match game's Uplay DLL name
        draft: false
        prerelease: false
        files: |
          release/uplay_emu_asi_x64.zip
          release/uplay_emu_asi_x86.zip
          release/uplay_r1_loader64.dll
          release/uplay_r1_loader.dll
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}